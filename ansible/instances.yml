- hosts: localhost
  connection: local

  vars:
    region: eu-west-1
    ami: ami-c39604b0
    env: p
    ipcode: P386
    system_code: 'Video-Platform'
    description: 'Video Platform'
    team_dl: james.condron@ft.com
    environment_tag: default
    storage_instance_type: m3.medium
    instance_type: m4.large
    short_name: mio

  tasks:
    - name: Create buckets
      s3_bucket:
        name: "mio-{{item}}-{{clusterid}}"
        region: "{{region}}"
      with_items:
        - raw
        - edit
        - raw-proxy
        - edit-proxy
        - audio
        - web-video

    - name: RDS Cluster
      shell: "aws rds create-db-cluster --db-cluster-identifier mio-db-{{clusterid}}-cluster --engine aurora --master-username admin --master-user-password {{db_password}} --tags Key=name,Value=mio-db-{{clusterid}}-cluster Key=environment,Value={{env}} Key=ipCode,Value={{ipcode}} Key=systemCode,Value={{system_code}} Key=teamDl,Value={{team_dl}} Key=stopSchedule,Value=nostop --vpc-security-group-ids {{private_security_group_id}} --db-subnet-group-name private-subnets"
      ignore_errors: yes

    - name: RDS Instance
      shell: "aws rds create-db-instance --db-instance-identifier mio-db-{{clusterid}}-host --engine aurora --db-cluster-identifier mio-db-{{clusterid}}-cluster --db-instance-class db.r3.xlarge --tags Key=name,Value=mio-db-{{clusterid}}-host Key=environment,Value={{env}} Key=ipCode,Value={{ipcode}} Key=systemCode,Value={{system_code}} Key=teamDL,Value={{team_dl}} Key=stopSchedule,Value=nostop --db-subnet-group-name private-subnets"
      ignore_errors: yes

    - name: RAW Transcoder
      shell: "aws elastictranscoder create-pipeline --name mio-{{clusterid}}-transcoder --input-bucket mio-raw-{{clusterid}} --output-bucket mio-raw-proxy-{{clusterid}} --role {{role}}"
      ignore_errors: yes

    - name: Build storage instance
      ec2:
        image: "{{ami}}"
        region: "{{region}}"
        key_name: "dios-mio"
        group_id:
          - "{{security_group_id}}"
          - "{{private_security_group_id}}"
        vpc_subnet_id: "{{private_subnet_2}}"
        assign_public_ip: no
        wait: true
        exact_count: 1
        count_tag:
          Name: "ftmio{{clusterid}}01-law1a-eu-{{env}}"
        instance_type: "{{storage_instance_type}}"
        instance_profile_name: FT-Linux-Role
        instance_tags:
          Name: "ftmio{{clusterid}}01-law1a-eu-{{env}}"
          environment: "{{env}}"
          ipCode: "{{ipcode}}"
          systemCode: "{{system_code}}"
          teamDL: "{{team_dl}}"
          stopSchedule: "nostop"
          mio_usage: "storage"
          cluster: "{{clusterid}}"
          description: "{{description}} storage box"
        user_data: |
          #!/bin/bash
          /usr/bin/aws s3 cp s3://ft-ce-repository/amazon-ftbase/releases/bootstrap.sh .
          bash ./bootstrap.sh

    - name: Build mio in a box instance
      ec2:
        image: "{{ami}}"
        region: "{{region}}"
        key_name: "dios-mio"
        group_id:
          - "{{security_group_id}}"
          - "{{private_security_group_id}}"
        vpc_subnet_id: "{{private_subnet_2}}"
        assign_public_ip: no
        wait: true
        exact_count: 1
        count_tag:
          Name: "ftmio{{clusterid}}02-law1a-eu-{{env}}"
        instance_type: "{{instance_type}}"
        instance_profile_name: FT-Linux-Role
        instance_tags:
          Name: "ftmio{{clusterid}}02-law1a-eu-{{env}}"
          environment: "{{env}}"
          ipCode: "{{ipcode}}"
          systemCode: "{{system_code}}"
          teamDL: "{{team_dl}}"
          stopSchedule: "nostop"
          mio_usage: "master"
          cluster: "{{clusterid}}"
          description: "{{description}} master box"
        user_data: |
          #!/bin/bash
          /usr/bin/aws s3 cp s3://ft-ce-repository/amazon-ftbase/releases/bootstrap.sh .
          bash ./bootstrap.sh

    - name: elasticsearch head one
      ec2:
        image: "{{ami}}"
        region: "{{region}}"
        key_name: "dios-mio"
        group_id:
          - "{{security_group_id}}"
          - "{{private_security_group_id}}"
        vpc_subnet_id: "{{private_subnet_2}}"
        assign_public_ip: no
        wait: true
        exact_count: 1
        count_tag:
          Name: "ftmio{{clusterid}}03-law1b-eu-{{env}}"
        instance_type: t2.small
        instance_profile_name: FT-Linux-Role
        instance_tags:
          Name: "ftmio{{clusterid}}03-law1b-eu-{{env}}"
          environment: "{{env}}"
          ipCode: "{{ipcode}}"
          systemCode: "{{system_code}}"
          teamDL: "{{team_dl}}"
          stopSchedule: "nostop"
          mio_usage: "elasticsearch"
          cluster: "{{clusterid}}"
          description: "{{description}} es head one"
        user_data: |
          #!/bin/bash
          /usr/bin/aws s3 cp s3://ft-ce-repository/amazon-ftbase/releases/bootstrap.sh .
          bash ./bootstrap.sh

    - name: elasticsearch head two
      ec2:
        image: "{{ami}}"
        region: "{{region}}"
        key_name: "dios-mio"
        group_id:
          - "{{security_group_id}}"
          - "{{private_security_group_id}}"
        vpc_subnet_id: "{{private_subnet_2}}"
        assign_public_ip: no
        wait: true
        exact_count: 1
        count_tag:
          Name: "ftmio{{clusterid}}04-law1a-eu-{{env}}"
        instance_type: t2.small
        instance_profile_name: FT-Linux-Role
        instance_tags:
          Name: "ftmio{{clusterid}}04-law1a-eu-{{env}}"
          environment: "{{env}}"
          ipCode: "{{ipcode}}"
          systemCode: "{{system_code}}"
          teamDL: "{{team_dl}}"
          stopSchedule: "nostop"
          mio_usage: "elasticsearch"
          cluster: "{{clusterid}}"
          description: "{{description}} es head two"
        user_data: |
          #!/bin/bash
          /usr/bin/aws s3 cp s3://ft-ce-repository/amazon-ftbase/releases/bootstrap.sh .
          bash ./bootstrap.sh

    - name: elasticsearch head three
      ec2:
        image: "{{ami}}"
        region: "{{region}}"
        key_name: "dios-mio"
        group_id:
          - "{{security_group_id}}"
          - "{{private_security_group_id}}"
        vpc_subnet_id: "{{private_subnet_2}}"
        assign_public_ip: no
        wait: true
        exact_count: 1
        count_tag:
          Name: "ftmio{{clusterid}}05-law1b-eu-{{env}}"
        instance_type: t2.small
        instance_profile_name: FT-Linux-Role
        instance_tags:
          Name: "ftmio{{clusterid}}05-law1b-eu-{{env}}"
          environment: "{{env}}"
          ipCode: "{{ipcode}}"
          systemCode: "{{system_code}}"
          teamDL: "{{team_dl}}"
          stopSchedule: "nostop"
          mio_usage: "elasticsearch"
          cluster: "{{clusterid}}"
          description: "{{description}} es head three"
        user_data: |
          #!/bin/bash
          /usr/bin/aws s3 cp s3://ft-ce-repository/amazon-ftbase/releases/bootstrap.sh .
          bash ./bootstrap.sh

    - name: mongodb
      ec2:
        image: "{{ami}}"
        region: "{{region}}"
        key_name: "dios-mio"
        group_id:
          - "{{security_group_id}}"
          - "{{private_security_group_id}}"
        vpc_subnet_id: "{{private_subnet_2}}"
        assign_public_ip: no
        wait: true
        exact_count: 1
        count_tag:
          Name: "ftmio{{clusterid}}06-law1b-eu-{{env}}"
        instance_type: t2.small
        instance_profile_name: FT-Linux-Role
        instance_tags:
          Name: "ftmio{{clusterid}}06-law1b-eu-{{env}}"
          environment: "{{env}}"
          ipCode: "{{ipcode}}"
          systemCode: "{{system_code}}"
          teamDL: "{{team_dl}}"
          stopSchedule: "nostop"
          mio_usage: "mongo"
          cluster: "{{clusterid}}"
          description: "{{description}} mongodb"
        user_data: |
          #!/bin/bash
          /usr/bin/aws s3 cp s3://ft-ce-repository/amazon-ftbase/releases/bootstrap.sh .
          bash ./bootstrap.sh
